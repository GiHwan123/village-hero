<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- 지도 API include -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c2c65e47ff9efd53c90ebd6f14d04ecb&libraries=services,clusterer,drawing"></script>	
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script> 
</head>
<body>	
	<template id="header">
		<div>
			<!-- header 부분 템플릿 여기다 만들기 -->
		</div>
	</template>

	<template id="side">
		<div>
			<!-- side 부분 템플릿 여기다 만들기 -->
		</div>
	</template>

	<template id="main">
		<div>			
			<div id="map" style="width:1000px;height:800px;"></div>				
		</div>
	</template>
	

	<div id="app">
		<main-com></main-com>					
	</div>
	
	
	<script>		
		Vue.component("main-com", {
			template: "#main",
			data: function(){
				return {
					allErrands: [],		
					erranderrandLocations: []			
				}
			},
			methods: {
				
			},
			created: function(){				
				axios({
					method: "get",
					url: "http://localhost:8088/errands"		
				}).then(resData => {						      			
					this.allErrands = resData.data;   
					this.errandLocations = resData.data.map(v => v.reqLocation); // 모든 심부름 정보의 위치만 빼서 errandLocations 배열에 담기			


					/*** 지도 생성하기 ***/
					var mapContainer = document.getElementById("map"); // 지도를 표시할 div 				
					var mapOption = { 
						center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
						level: 3 // 지도의 확대 레벨
					};				
					var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 표시할 div와 지도 옵션으로 지도를 생성

					if (navigator.geolocation) {					
						navigator.geolocation.getCurrentPosition(function(position) { // GeoLocation을 이용해서 현 접속 위치 가져오기				
							var lat = position.coords.latitude; // 위도
							var	lon = position.coords.longitude; // 경도						
							var locPosition = new kakao.maps.LatLng(lat, lon); 		

							map.setCenter(locPosition); // 지도 중심위치를 현 접속위치로 변경						
						});
					}
					

					/*** 지도에 마커 표시 ***/				
					var geocoder = new kakao.maps.services.Geocoder(); // 주소-좌표 변환 객체를 생성
					
					// errandLocations 에 담긴 모든 심부름 주소들에 대해
					for (var i=0; i<this.errandLocations.length; i++){
						geocoder.addressSearch(this.errandLocations[i], function(result, status) {					
							if (status === kakao.maps.services.Status.OK) { // 정상적으로 검색이 완료됐으면 
								var coords = new kakao.maps.LatLng(result[0].y, result[0].x);  // 좌표로 변환
	
								// 결과값으로 받은 위치를 마커로 표시합니다
								var marker = new kakao.maps.Marker({
									map: map,
									position: coords
								});
							}
						});
					}
				}).catch(error => {
					console.log("error", error);
				});  
				
			}		
		});
		
		
		new Vue({
            el: "#app"            
        });

	</script>
	
</body>
</html>